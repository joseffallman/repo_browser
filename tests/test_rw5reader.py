import pytest

from src.rw5_reader import (
    change_jobb_name,
    change_point_id,
    get_all_points,
    get_point,
    get_rw5_header,
    json_to_rw5,
    rw5_to_json,
)

# Testdata
data = """
JB,NMNYADAL,DT03-17-2021,TM14:45:50
MO,AD0,UN1,SF1.00000000,EC0,EO0.0,AU0
--SurvCE Version 5.02
--CRD: Alphanumeric
--User Defined: SWEDEN/SWEREF 99 TM
--Equipment:   SatLab,  SL300, SN:BJYA15220199R C2SR0G550, FW:6.600 2015/Jan/28
--Antenna Type: [SL300EXT        NONE],RA0.0890m,SHMP0.0415m,L10.0591m,L20.0596m,--SL300 GNSS External Antenna
--Localization File: None
--Geoid Separation File: \Storage Card\Geoids\SW082000_Syd.gsf N54°37'11.0" E011°11'59.0" N58°15'36.0" E019°04'47.0"
--Grid Adjustment File: None
--GPS Scale: 1.00000000
--Scale Point not used
--RTK Method: RTCM V3.0, Device: Data Collector Internet, Network: NTRIP RTCM3_GNSS
BP,PN2234,LA56.534186799288,LN14.580284398934,EL234.9404,AG0.0000,PA0.0000,ATARP,SRROVER,--
--Entered Rover HR: 2.0000 m, Vertical
LS,HR2.0591
GPS,PN1,LA56.534182082079,LN14.580282246876,EL233.590624,--K ST el_SKP
--GS,PN1,N 6305692.8417,E 498017.1303,EL199.0365,--K ST el_SKP
--GT,PN1,SW2149,ST305982500,EW2149,ET305982500
--HSDV:0.011, VSDV:0.016, STATUS:FIXED, SATS:23, PDOP:1.350, HDOP:0.712, VDOP:1.147, TDOP:1.115, GDOP:1.751, NSDV:0.007, ESDV:0.009
--DT03-17-2021
--TM14:45:53
GPS,PN2,LA56.534180905203,LN14.580283080088,EL233.543759,--L
--GS,PN2,N 6305692.4777,E 498017.2712,EL198.9896,--L
--GT,PN2,SW2149,ST306013000,EW2149,ET306013000
--HSDV:0.011, VSDV:0.015, STATUS:FIXED, SATS:23, PDOP:1.342, HDOP:0.712, VDOP:1.138, TDOP:1.108, GDOP:1.740, NSDV:0.006, ESDV:0.009
--DT03-17-2021
--TM14:46:22
GPS,PN3,LA56.534188995972,LN14.580293123618,EL233.599757,--K
--GS,PN3,N 6305694.9786,E 498018.9719,EL199.0457,--K
--GT,PN3,SW2149,ST306091000,EW2149,ET306091000
--HSDV:0.011, VSDV:0.015, STATUS:FIXED, SATS:23, PDOP:1.332, HDOP:0.712, VDOP:1.126, TDOP:1.098, GDOP:1.726, NSDV:0.006, ESDV:0.009
--DT03-17-2021
--TM14:47:40
GPS,PN4,LA56.534196796345,LN14.580307371472,EL233.410173,--K
--GS,PN4,N 6305697.3894,E 498021.3841,EL198.8562,--K
--GT,PN4,SW2149,ST306101500,EW2149,ET306101500
--HSDV:0.011, VSDV:0.016, STATUS:FIXED, SATS:22, PDOP:1.265, HDOP:0.674, VDOP:1.070, TDOP:1.034, GDOP:1.634, NSDV:0.007, ESDV:0.008
--DT03-17-2021
--TM14:47:51
GPS,PN4,LA56.534196796345,LN14.580307371472,EL233.410173,--K el_SKP
--GS,PN4,N 6305697.3894,E 498021.3841,EL198.8562,--K el_SKP
--GT,PN4,SW2149,ST306101500,EW2149,ET306101500
--HSDV:0.011, VSDV:0.016, STATUS:FIXED, SATS:22, PDOP:1.265, HDOP:0.674, VDOP:1.070, TDOP:1.034, GDOP:1.634, NSDV:0.007, ESDV:0.008
--DT03-17-2021
--TM14:47:55
GPS,PN5,LA56.534208496110,LN14.580317734452,EL233.250896,--K
--GS,PN5,N 6305701.0062,E 498023.1394,EL198.6970,--K
--GT,PN5,SW2149,ST306112000,EW2149,ET306112000
--HSDV:0.011, VSDV:0.017, STATUS:FIXED, SATS:22, PDOP:1.264, HDOP:0.674, VDOP:1.069, TDOP:1.032, GDOP:1.632, NSDV:0.007, ESDV:0.008
--DT03-17-2021
--TM14:48:01
GPS,PN22,LA56.534208496110,LN14.580317734452,EL233.250896,--K
--GS,PN22,N 6305701.0062,E 498023.1394,EL198.6970,--K
--GT,PN22,SW2149,ST306112000,EW2149,ET306112000
--HSDV:0.011, VSDV:0.017, STATUS:FIXED, SATS:22, PDOP:1.264, HDOP:0.674, VDOP:1.069, TDOP:1.032, GDOP:1.632, NSDV:0.007, ESDV:0.008
--DT03-17-2021
--TM14:48:01
GPS,PN23,LA56.534208496110,LN14.580317734452,EL233.250896,--K
--GS,PN23,N 6305701.0062,E 498023.1394,EL198.6970,--K
--GT,PN23,SW2149,ST306112000,EW2149,ET306112000
--HSDV:0.011, VSDV:0.017, STATUS:FIXED, SATS:22, PDOP:1.264, HDOP:0.674, VDOP:1.069, TDOP:1.032, GDOP:1.632, NSDV:0.007, ESDV:0.008
--DT03-17-2021
--TM14:48:01
"""

data2 = """
JB,NM000123123123,DT08-21-2024,TM12:33:29
MO,AD0,UN1,SF1.00000000,EC0,EO0.0,AU0
--SurvPC Version 6.12
--CRD: Alphanumeric
--Projection: SWEDEN/SWEREF 99 TM
--JAKUND:EON
--DT08-21-2024
--TM12:33:48
--Equipment:   eSurvey,  E300 Pro, SN:E31P3A2200819, FW:6.0Aa05b,1.19,0.23.220518
--Antenna Type: [EE300SX113A],RA0.0790m,SHMP0.0400m,L10.0720m,L20.0620m,--L1/L2 Antenna
--Localization File: None
--Geoid Separation File: C:\Carlson Projects\Data\Geoids\SW082000_Syd.gsf N54°37'11.0" E011°11'59.0" N58°15'36.0" E019°04'47.0"
--Grid Adjustment File: None
--GPS Scale: 1.00000000
--Scale Point not used
--RTK Method: RTCM V3.0, Device: Data Collector Internet, Network: NTRIP MSM_GNSS
BP,PN1351_BASE_1,LA56.284299628872,LN15.074063252152,EL158.0350,AG0.0000,PA0.0720,ATAPC,SRROVER,--
--Entered Rover HR: 2.0000 m, Slant
LS,HR2.0304
GPS,PN1,LA56.284299043380,LN15.074060377000,EL158.326000,--A K ST
--GS,PN1,N 6259355.9767,E 507880.3851,EL123.5254,--A K ST
G0,2024/08/21 10:36:25,Base ID read at rover: 1351
G1,BP1351_BASE_1,PN1,DX0.42622,DY-0.39074,DZ0.14285
G2,VX0.00003137,VY0.00001229,VZ0.00018368
G3,XY0.00000202,XZ-0.00001205,YZ0.00000819
--GSRD,TXD24.845,TYD-12.099,THD205.137,TDTeSurvey_E300 Pro
--GSAL,TEL-0.398,TNL-0.848,TZL0.229,T2D0.936,TTL0.015
--GT,PN1,SW2328,ST297403000,EW2328,ET297403000
--HSDV:0.012, VSDV:0.014, STATUS:FIXED, SATS:22, AGE:1.0, PDOP:1.016, HDOP:0.500, VDOP:0.885, TDOP:0.833, GDOP:0.583, NSDV:0.011, ESDV:0.004
--DT08-21-2024
--TM12:33:49
GPS,PN2,LA56.284299506700,LN15.074060724520,EL158.374000,--R
--GS,PN2,N 6259356.2305,E 507880.3633,EL123.5448,--R
G0,2024/08/21 10:36:29,Base ID read at rover: 1351
G1,BP1351_BASE_1,PN2,DX0.32693,DY-0.36031,DZ0.26226
G2,VX0.00002703,VY0.00001093,VZ0.00013210
G3,XY0.00000191,XZ0.00000350,YZ0.00000827
--GSRD,TXD21.267,TYD-14.702,THD212.996,TDTeSurvey_E300 Pro
--GSAL,TEL-0.479,TNL-0.737,TZL0.200,T2D0.879,TTL0.015
--GT,PN2,SW2328,ST297407600,EW2328,ET297407600
--HSDV:0.009, VSDV:0.011, STATUS:FIXED, SATS:21, AGE:1.6, PDOP:1.069, HDOP:0.600, VDOP:0.885, TDOP:0.896, GDOP:0.583, NSDV:0.008, ESDV:0.004
--DT08-21-2024
--TM12:33:53
GPS,PN3,LA56.284302140160,LN15.074065176160,EL158.028000,--K
--GS,PN3,N 6259357.7975,E 507881.7906,EL123.0074,--K
G0,2024/08/21 10:36:38,Base ID read at rover: 1351
G1,BP1351_BASE_1,PN3,DX-0.51616,DY0.01098,DZ0.45052
G2,VX0.00014787,VY0.00004333,VZ0.00032156
G3,XY-0.00002735,XZ0.00004430,YZ0.00001393
--GSRD,TXD4.952,TYD1.993,THD85.737,TDTeSurvey_E300 Pro
--GSAL,TEL0.188,TNL0.014,TZL0.009,T2D0.189,TTL0.015
--GT,PN3,SW2328,ST297416800,EW2328,ET297416800
--HSDV:0.017, VSDV:0.020, STATUS:FIXED, SATS:20, AGE:0.8, PDOP:1.263, HDOP:0.500, VDOP:1.160, TDOP:0.940, GDOP:0.844, NSDV:0.014, ESDV:0.009
--DT08-21-2024
--TM12:34:02
GPS,PN4,LA56.284312927920,LN15.074060153620,EL157.746000,--K
--GS,PN4,N 6259361.3242,E 507881.1800,EL122.7765,--K
G0,2024/08/21 10:36:45,Base ID read at rover: 1351
G1,BP1351_BASE_1,PN4,DX-3.16155,DY-1.50537,DZ2.03005
G2,VX0.00065585,VY0.00009962,VZ0.00038871
G3,XY-0.00017389,XZ0.00031402,YZ-0.00005278
--GSRD,TXD11.051,TYD8.552,THD64.971,TDTeSurvey_E300 Pro
--GSAL,TEL0.443,TNL0.207,TZL0.060,T2D0.489,TTL0.015
--GT,PN4,SW2328,ST297423800,EW2328,ET297423800
--HSDV:0.025, VSDV:0.031, STATUS:FIXED, SATS:19, AGE:1.8, PDOP:1.010, HDOP:0.500, VDOP:0.877, TDOP:0.828, GDOP:0.578, NSDV:0.018, ESDV:0.018
--DT08-21-2024
--TM12:34:09
GPS,PN5,LA56.284322319780,LN15.074062334860,EL157.670000,--K
--GS,PN5,N 6259364.0267,E 507881.6263,EL122.7089,--K
G0,2024/08/21 10:36:51,Base ID read at rover: 1351
G1,BP1351_BASE_1,PN5,DX-5.66164,DY-1.81130,DZ3.56411
G2,VX0.00066705,VY0.00011100,VZ0.00048336
G3,XY-0.00016894,XZ0.00035115,YZ-0.00006647
--GSRD,TXD13.537,TYD6.261,THD89.464,TDTeSurvey_E300 Pro
--GSAL,TEL0.522,TNL0.005,TZL0.068,T2D0.522,TTL0.015
--GT,PN5,SW2328,ST297429000,EW2328,ET297429000
--HSDV:0.024, VSDV:0.031, STATUS:FIXED, SATS:21, AGE:1.0, PDOP:1.004, HDOP:0.500, VDOP:0.871, TDOP:0.830, GDOP:0.565, NSDV:0.017, ESDV:0.017
--DT08-21-2024
--TM12:34:15
GPS,PN6,LA56.284327675380,LN15.074068517260,EL157.628000,--K
--GS,PN6,N 6259365.5323,E 507882.5653,EL122.6452,--K
G0,2024/08/21 10:36:55,Base ID read at rover: 1351
G1,BP1351_BASE_1,PN6,DX-7.33430,DY-1.16155,DZ4.44582
G2,VX0.00013499,VY0.00004519,VZ0.00017788
G3,XY-0.00000255,XZ0.00009619,YZ0.00000899
--GSRD,TXD11.415,TYD4.566,THD109.935,TDTeSurvey_E300 Pro
--GSAL,TEL0.406,TNL-0.147,TZL0.046,T2D0.432,TTL0.015
--GT,PN6,SW2328,ST297433400,EW2328,ET297433400
--HSDV:0.011, VSDV:0.017, STATUS:FIXED, SATS:25, AGE:1.4, PDOP:0.972, HDOP:0.500, VDOP:0.834, TDOP:0.815, GDOP:0.530, NSDV:0.008, ESDV:0.008
--DT08-21-2024
--TM12:34:19
"""


def test_get_point():
    # Testar om vi kan hämta en specifik punkt (t.ex. PN1)
    point = get_point(data, 4)
    assert point.startswith("GPS,PN4")
    assert point.endswith("--TM14:47:55\n")

    # Testa en annan punkt (t.ex. PN23)
    point = get_point(data, 23)
    assert point.startswith("GPS,PN23")
    assert point.endswith("--TM14:48:01\n")


def test_get_point2():
    # Testar om vi kan hämta en specifik punkt (t.ex. PN1)
    point = get_point(data2, 4)
    assert point.startswith("GPS,PN4")
    assert point.endswith("--TM12:34:09\n")

    # Testa en annan punkt (t.ex. PN23)
    point = get_point(data2, 6)
    assert point.startswith("GPS,PN6")
    assert point.endswith("--TM12:34:19\n")


def test_get_all_points():
    # Kontrollera om alla punkter kan hämtas
    points = get_all_points(data)
    assert len(points) == 8  # Kontrollera att vi har fått flera punkter


def test_get_rw5_header():
    # Testa om vi kan hämta rubriken från data
    header = get_rw5_header(data)
    assert header.startswith("JB,NMNYADAL,DT03-17-2021,TM14:45:50")
    assert header.endswith("LS,HR2.0591\n")


def test_change_jobb_name():
    # Testa om vi kan ändra jobbnamnet
    updated_data = change_jobb_name(get_rw5_header(data), "0003215")
    assert "JB,NM0003215" in updated_data


def test_change_point_id():
    # Testa om vi kan ändra ID på en punkt (t.ex. PN5)
    updated_data = change_point_id(data, 2, 5)
    point = get_point(updated_data, 7)
    assert point.startswith("GPS,PN7")


def test_rw5_to_json_and_back():
    # Testa om vi kan konvertera till JSON och tillbaka till RW5
    json_data = rw5_to_json(data)
    rw5_data = json_to_rw5(json_data)
    assert "JB,NMNYADAL,DT03-17-2021,TM14:45:50" in rw5_data
    assert "GPS,PN1,LA56.534182082079,LN14.580282246876,EL233.590624" in rw5_data
