{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    /* GitHub-liknande filstruktur */
    .file-list {
        list-style: none;
        padding-left: 0;
    }

    .file-list li {
        border-bottom: 1px solid #e1e4e8;
        padding: 8px 10px;
        display: block;
        align-items: center;
    }

    .file-list li a {
        text-decoration: none;
        color: #0366d6;
        font-weight: 600;
        /* flex-grow: 1;*/
    }

    .file-list li a:hover {
        text-decoration: underline;
    }

    .file-list li .file-type {
        margin-right: 8px;
        width: 16px;
        height: 16px;
        display: inline-block;
    }

    .file-list li .folder-icon {
        background: url('https://github.githubassets.com/images/icons/emoji/unicode/1f4c1.png') no-repeat center center;
        background-size: contain;
    }

    .file-list li .file-icon {
        background: url('https://github.githubassets.com/images/icons/emoji/unicode/1f4c4.png') no-repeat center center;
        background-size: contain;
    }

    /* Plus och upload knapp */
    .plus-button,
    .upload-button,
    .search-button {
        position: fixed;
        width: 50px;
        height: 50px;
        background-color: #007BFF;
        color: white;
        border-radius: 50%;
        font-size: 30px;
        text-align: center;
        line-height: 50px;
        cursor: pointer;
        padding: 0px 0px;
    }

    .plus-button {
        bottom: 20px;
        right: 20px;
    }

    .upload-button {
        bottom: 80px;
        right: 20px;
    }

    .search-button {
        bottom: 140px;
        right: 20px;
    }

    /* Redigeringsmodal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 800px;
        text-align: center;
    }

    .search-modal-content {
        min-height: 60vh;
    }

    .modal-content textarea {
        width: 100%;
        height: 400px;
        font-family: monospace;
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
    }

    .modal-content input[type="text"],
    .modal-content input[type="file"] {
        width: 80%;
        padding: 10px;
        margin-bottom: 20px;
    }

    .modal-content button {
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        cursor: pointer;
    }

    .modal-content button.close-btn {
        background-color: red;
    }

    /* Flikstyling */
    .tab {
        overflow: hidden;
        border-bottom: 1px solid #ccc;
    }

    .tab button {
        background-color: #007BFF;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 4px 16px 4px;
        margin-top: 10px;
        transition: 0.3s;
        border-radius: 5px 5px 0px 0px;
    }

    .tab button:hover {
        background-color: #0366d6;
    }

    .tab button.active {
        background-color: #0366d6;
        padding: 14px 16px 4px;
        margin-top: 0px
    }

    .tabcontent {
        display: none;
        padding: 6px 12px;
        border-top: none;
    }

    #map {
        height: 400px;
        width: 100%;
        margin-bottom: 20px;
    }
</style>
<style>
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: fixed;
        /* Absolut positionering ändrad till fixed för att alltid vara centrerad på skärmen */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        /* Centrera laddningsindikatorn */
        z-index: 10;
        /* Se till att laddningsindikatorn ligger över trädinnehållet */
    }

    .loading-spinner-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .loading-spinner {
        width: 100px;
        height: 100px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        position: absolute;
        /* Texten centreras ovanpå spinnern */
        font-size: 16px;
        color: #3498db;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Grå overlay*/
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        /* Halvtransparent svart/grå ton */
        z-index: 5;
        /* Ligger under loading-container men över resten */
        display: none;
        /* Dold som standard */
    }
</style>
{% endblock %}

{% block title %}Innehåll i projekt: {{ repo_name }}{% endblock %}
{% block body %}
<!-- Loading symbol -->
<div class="overlay" id="overlay"></div> <!-- Grå overlay -->
<div class="loading-container" id="loading-spinner" style="display: none;">
    <div class="loading-spinner-wrapper">
        <div class="loading-spinner"></div>
        <div class="loading-text">Laddar...</div>
    </div>
</div>


<!-- Plus-knapp -->
<button class="plus-button" id="openCreateModal">
    <span class="iconify" data-icon="mdi-folder-plus-outline"></span>
</button>

<!-- Upload-knapp -->
<button class="upload-button" id="openUploadModal">
    <span class="iconify" data-icon="mdi-file-upload-outline"></span>
</button>

<!-- Sök-knapp -->
<button class="search-button" id="openSearchModal">
    <span class="iconify" data-icon="mdi-search"></span>
</button>

<!-- Modal för sökning -->
<div id="searchModal" class="modal">
    <div class="modal-content search-modal-content">
        <h2>Sök efter filer eller mappar</h2>
        <form id="searchForm">
            <label for="searchTerm">Ange sökord:</label>
            <input type="text" id="searchTerm" name="searchTerm">
            <button type="submit">Sök</button>
            <button type="button" class="close-btn" id="closeSearchModal">Avbryt</button>
        </form>
        <!-- Loading symbol -->

        <div class="overlay" id="overlay-search" style="position: relative;"></div> <!-- Grå overlay -->
        <div class="loading-container" id="loading-spinner-search" style="display: none;">
            <div class="loading-spinner-wrapper">
                <div class="loading-spinner"></div>
                <div class="loading-text">Laddar...</div>
            </div>
        </div>
        <ul id="treeList" class="file-list">
        </ul>
    </div>
</div>


<!-- Modal för att redigera filer -->
<div id="editFileModal" class="modal">
    <div class="modal-content">

        <!-- Flikar -->
        <div class="tab">
            <button class="tablinks" id="defaultOpen" onclick="openTab(event, 'FileView')">Visa</button>
            <button class="tablinks" id="editTab" onclick="openTab(event, 'FileContent')">Redigera</button>
            <button class="tablinks" id="mapTab" style="display:none;" onclick="openTab(event, 'Map')">Karta</button>
        </div>

        <!-- Flikinnehåll -->
        <div id="FileView" class="tabcontent">
            <p class="h3">Granska fil</p>
            <p class="filepathlabel small"></p>
            <textarea id="viewFileContent" class="file-content" disabled></textarea>
            <button type="button" class="close-btn" id="closeEditModal">Avbryt</button>
        </div>

        <div id="FileContent" class="tabcontent">
            <p class="h3">Redigera fil</p>
            <p class="filepathlabel small"></p>
            <form id="editFileForm" action="{{ url_for('edit_file', repo_name=repo_name) }}" method="post">
                <input type="hidden" name="path" id="editFilePath">
                <input type="hidden" name="owner" value="{{ owner }}">
                <textarea name="content" id="editFileContent"></textarea>
                <br>
                <button type="submit">Spara ändringar</button>
                <button type="button" class="close-btn" id="closeEditModal">Avbryt</button>
            </form>
        </div>

        <div id="Map" class="tabcontent">
            <h3>Karta</h3>
            <div id="map"></div>
            <button type="button" class="close-btn" id="closeEditModal">Avbryt</button>
        </div>



    </div>
</div>


<!-- Navigering -->
<div class="tree">
    {% include 'tree_content.html' %}
</div>

<a href="{{ url_for('repos') }}">Tillbaka till listan över projekt</a>


<div class="text-center">
    <a href="{{ url_for('logout') }}" class="btn btn-primary btn-lg">
        <i class="bi bi-github"></i> Logga ut.
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Öppna modalen för att skapa mapp
    document.getElementById('openCreateModal').onclick = function () {
        document.getElementById('createFolderModal').style.display = 'block';
    }

    // Stäng modalen för att skapa mapp
    document.getElementById('closeCreateModal').onclick = function () {
        document.getElementById('createFolderModal').style.display = 'none';
    }

    // Öppna modalen för att ladda upp fil
    document.getElementById('openUploadModal').onclick = function () {
        document.getElementById('uploadFileModal').style.display = 'block';
    }

    // Stäng modalen för att ladda upp fil
    document.getElementById('closeUploadModal').onclick = function () {
        document.getElementById('uploadFileModal').style.display = 'none';
    }

    // Öppna modalen för att söka
    document.getElementById('openSearchModal').onclick = function () {
        document.getElementById('searchModal').style.display = 'block';
    }

    // Stäng modalen för att söka
    document.getElementById('closeSearchModal').onclick = function () {
        document.getElementById('searchModal').style.display = 'none';
    }

    // Stäng modal om användaren klickar utanför eller på avbryt knappen
    window.onclick = function (event) {
        if (event.target == document.getElementById('createFolderModal') ||
            event.target == document.getElementById('closeCreateModal')
        ) {
            document.getElementById('createFolderModal').style.display = 'none';
        }
        if (event.target == document.getElementById('uploadFileModal') ||
            event.target == document.getElementById('closeUploadModal')
        ) {
            document.getElementById('uploadFileModal').style.display = 'none';
        }
        if (event.target == document.getElementById('searchModal') ||
            event.target == document.getElementById('closeSearchModal')
        ) {
            document.getElementById('searchModal').style.display = 'none';
        }
    }
</script>
<script>
    // Hantera sökningen
    document.getElementById("searchForm").addEventListener("submit", function (event) {
        event.preventDefault();
        var searchTerm = document.getElementById("searchTerm").value.toLowerCase();
        var sha = "{{ request.args.get('sha', 'HEAD') }}";
        var treeList = document.getElementById("treeList");
        treeList.innerHTML = ''; // Töm listan
        const loadingSpinner = document.getElementById('loading-spinner-search');
        // Visa laddar-symbolen
        loadingSpinner.style.display = 'flex';
        const overlay = document.getElementById('overlay-search');
        overlay.style.display = "block";

        fetch(`{{ url_for('search_repo', repo_name=repo_name, owner=owner) }}?q=${searchTerm}&sha=${sha}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    // Om inga resultat hittades
                    var li = document.createElement("li");
                    li.textContent = "Inget resultat";
                    treeList.appendChild(li);
                } else {
                    data.forEach(function (item) {
                        var li = document.createElement("li");
                        if (item.type === 'tree') {
                            li.innerHTML = `<span class="file-type folder-icon"></span> <a href="${item.href}" class="searchresult">${item.path}</a>`;
                        } else if (item.type === 'blob') {
                            li.innerHTML = `<span class="file-type file-icon"></span> <a href="${item.href}" class="searchresult">${item.path}</a>`;
                        }
                        treeList.appendChild(li);
                    });
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                // Dölj laddar-symbolen
                loadingSpinner.style.display = 'none';
                overlay.style.display = "none";
            });
    });

    // Ladda mappar dynamiskt med event delegation och laddar-symbol
    document.addEventListener('DOMContentLoaded', function () {
        var searchtreeList = document.getElementById("treeList");

        searchtreeList.addEventListener('click', function (event) {
            if (event.target.tagName === 'A' && event.target.closest('.searchresult')) {
                event.preventDefault();
                let url = event.target.getAttribute('href');
                load_tree_content(url)
                document.getElementById('searchModal').style.display = 'none';
            }
        });
    });
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Proj4JS Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>
<!-- Proj4Leaflet Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>

<script>
    // Kontrollera om kartan redan är skapad
    let map;

    // Funktion för att öppna en flik
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;

        // Dölj allt flikinnehåll
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Ta bort 'active' klassen från alla flikar
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Visa nu vald flik och lägg till 'active' klassen på den valda knappen
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // Funktion för att skapa rätt crs
    function crs(fileContent) {
        var crs = new L.Proj.CRS('EPSG:3006',
            '+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs',
            {
                resolutions: [8192, 4096, 2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2, 1, 0.5, 0.25, 0.125],
                origin: [0, 0]
            });
        return crs;
    }

    // Definiera SWEREF 99 TM (EPSG:3006)
    proj4.defs("EPSG:3006", "+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs");

    // Definiera SWEREF 99 13 30 (EPSG:3007)
    proj4.defs("EPSG:3007", "+proj=utm +zone=13 +ellps=GRS80 +units=m +no_defs");

    // Definiera SWEREF 99 15 00 (EPSG:3008)
    proj4.defs("EPSG:3008", "+proj=utm +zone=15 +ellps=GRS80 +units=m +no_defs");

    // Funktion för att konvertera SWEREF 99 TM till WGS84
    function convertToWGS84(nor, eas, sourceProjection) {
        // Kontrollera om sourceProjection är definierad, annars använd standard (EPSG:3006)
        const sourceProj = sourceProjection || "EPSG:3006";

        const sourceCoords = [eas, nor]; // Ordning: [easting, northing]
        const wgs84 = proj4(sourceProj, "EPSG:4326", sourceCoords); // Konvertera till WGS84
        return wgs84; // Returnera [long, lat]
    }

    // Funktion för att visa en Leaflet-karta
    function displayMap(fileContent) {
        if (map) {
            map.remove();
        }

        map = L.map('map').setView([59.8586, 17.6389], 18);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 25,
            maxNativeZoom: 19
        }).addTo(map);

        // Skapa en array för att hålla alla koordinater
        const bounds = [];

        // Loopar igenom punkterna och lägger till dem på kartan
        fileContent.points.forEach(point => {
            const wgs84Coords = convertToWGS84(point.nor, point.eas);
            const latLng = [wgs84Coords[1], wgs84Coords[0]]; // [lat, long]

            const marker = L.marker(latLng).addTo(map); // [lat, long]
            marker.bindPopup(`ID:<b>${point.id}</b><br>Kod:<b>${point.des}</b><br>N: ${point.nor}<br>E: ${point.eas}`, { autoPan: false });
            // Öppna popupen när markören klickas
            marker.on('click', function () {
                marker.openPopup();
            });

            // Lägg till koordinaterna i bounds-arrayen
            bounds.push(latLng);
        });

        map.fitBounds(bounds, { padding: [20, 20] });
        console.log('Bounds:', bounds);
        map.whenReady(function () {
            map.fitBounds(bounds, { padding: [20, 20] });
        });


    }
</script>

<script>
    // Öppna redigeringsmodalen
    document.querySelector('.tree').addEventListener('click', function (event) {
        if (event.target.classList.contains('edit-file-link')) {
            event.preventDefault();
            const filePath = event.target.dataset.filepath;
            document.getElementById("mapTab").style.display = "none";
            document.getElementById('editFilePath').value = "";
            document.getElementById('editFileContent').value = "";
            document.getElementById('viewFileContent').value = "";
            document.getElementById('editFileModal').style.display = 'block';


            const filepathLabels = document.querySelectorAll('.filepathlabel');
            filepathLabels.forEach(element => {
                element.innerHTML = "";
            });

            // Öppna den första fliken som standard
            document.getElementById("defaultOpen").click();

            fetch(`{{ url_for('get_file_content', repo_name=repo_name, owner=owner) }}?path=${filePath}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('editFilePath').value = filePath;
                    document.getElementById('editFileContent').value = data.content;
                    document.getElementById('viewFileContent').value = data.content;
                    filepathLabels.forEach(element => {
                        element.innerHTML = filePath;
                    });


                    // Kolla om filen är en .crd fil
                    if (filePath.endsWith('.crd')) {
                        document.getElementById("mapTab").style.display = "inline-block";
                        //openTab(null, 'Map');  // Öppna kartfliken
                        document.getElementById("mapTab").click();
                        displayMap(JSON.parse(data.content));  // Visa kartan
                    } else {
                        document.getElementById("mapTab").style.display = "none";
                        //openTab(null, 'FileContent');  // Öppna filfliken
                    }
                    // Öppna den första fliken som standard
                    document.getElementById("defaultOpen").click();
                })
                .catch(error => console.error('Error:', error));
        }
    });


    document.addEventListener('click', function (event) {
        // Kontrollera om klicket är på knappen för att stänga redigeringsmodulen
        if (event.target && event.target.id === 'closeEditModal') {
            document.getElementById('editFileModal').style.display = 'none';
        }

        // Kontrollera om användaren klickade utanför modalen för att stänga den
        const editFileModal = document.getElementById('editFileModal');
        if (event.target === editFileModal) {
            editFileModal.style.display = 'none';
        }
    });
</script>

<script>
    // Ladda mappar dynamiskt med event delegation och laddar-symbol
    document.addEventListener('DOMContentLoaded', function () {
        const treeContainer = document.querySelector('.tree');

        treeContainer.addEventListener('click', function (event) {
            if (event.target.tagName === 'A' && event.target.closest('.folder')) {
                event.preventDefault();
                let url = event.target.getAttribute('href');
                load_tree_content(url)
            }
        });
    });

    function load_tree_content(url) {
        const treeContainer = document.querySelector('.tree');

        // Visa laddar-symbolen
        const loadingSpinner = document.getElementById('loading-spinner');
        loadingSpinner.style.display = 'flex'; // Flex för att använda flexbox
        const overlay = document.getElementById('overlay');
        overlay.style.display = "block";

        fetch(url, {
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
            .then(response => response.text())
            .then(html => {
                // Uppdatera innehållet
                treeContainer.innerHTML = html;
                treeContainer.appendChild(loadingSpinner); // Lägg tillbaka laddar-symbolen i DOM:en
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                // Dölj laddar-symbolen
                loadingSpinner.style.display = 'none';
                overlay.style.display = 'none';
            });
    };
</script>
{% endblock %}