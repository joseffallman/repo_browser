{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
    /* GitHub-liknande filstruktur */
    .file-list {
        list-style: none;
        padding-left: 0;
    }

    .file-list li {
        border-bottom: 1px solid #e1e4e8;
        padding: 8px 10px;
        display: block;
        align-items: center;
    }

    .file-list li a {
        text-decoration: none;
        color: #0366d6;
        font-weight: 600;
        /* flex-grow: 1;*/
    }

    .file-list li a:hover {
        text-decoration: underline;
    }

    .file-list li .file-type {
        margin-right: 8px;
        width: 16px;
        height: 16px;
        display: inline-block;
    }

    .file-list li .folder-icon {
        background: url('https://github.githubassets.com/images/icons/emoji/unicode/1f4c1.png') no-repeat center center;
        background-size: contain;
    }

    .file-list li .file-icon {
        background: url('https://github.githubassets.com/images/icons/emoji/unicode/1f4c4.png') no-repeat center center;
        background-size: contain;
    }

    /* Plus och upload knapp */
    .plus-button,
    .upload-button,
    .search-button {
        position: fixed;
        width: 50px;
        height: 50px;
        background-color: #007BFF;
        color: white;
        border-radius: 50%;
        font-size: 30px;
        text-align: center;
        line-height: 50px;
        cursor: pointer;
        padding: 0px 0px;
    }

    .plus-button {
        bottom: 20px;
        right: 20px;
    }

    .upload-button {
        bottom: 80px;
        right: 20px;
    }

    .search-button {
        bottom: 140px;
        right: 20px;
    }

    /* Redigeringsmodal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 800px;
        text-align: center;
    }

    .modal-content textarea {
        width: 100%;
        height: 400px;
        font-family: monospace;
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
    }

    .modal-content input[type="text"],
    .modal-content input[type="file"] {
        width: 80%;
        padding: 10px;
        margin-bottom: 20px;
    }

    .modal-content button {
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        cursor: pointer;
    }

    .modal-content button.close-btn {
        background-color: red;
    }
</style>
<style>
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: absolute;
        /* Absolut positionering för att centrera */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        /* Centrera laddningsindikatorn */
        z-index: 10;
        /* Se till att laddningsindikatorn ligger över trädinnehållet */
    }

    .loading-spinner-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .loading-spinner {
        width: 100px;
        height: 100px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        position: absolute;
        /* Texten centreras ovanpå spinnern */
        font-size: 16px;
        color: #3498db;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block title %}Innehåll i projekt: {{ repo_name }}{% endblock %}
{% block body %}
<!-- Loading symbol -->
<div class="loading-container" id="loading-spinner" style="display: none;">
    <div class="loading-spinner-wrapper">
        <div class="loading-spinner"></div>
        <div class="loading-text">Laddar...</div>
    </div>
</div>


<!-- Plus-knapp -->
<button class="plus-button" id="openCreateModal">
    <span class="iconify" data-icon="mdi-folder-plus-outline"></span>
</button>

<!-- Upload-knapp -->
<button class="upload-button" id="openUploadModal">
    <span class="iconify" data-icon="mdi-file-upload-outline"></span>
</button>

<!-- Sök-knapp -->
<button class="search-button" id="openSearchModal">
    <span class="iconify" data-icon="mdi-search"></span>
</button>

<!-- Modal för sökning -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <h2>Sök efter filer eller mappar</h2>
        <form id="searchForm">
            <label for="searchTerm">Ange sökord:</label>
            <input type="text" id="searchTerm" name="searchTerm">
            <button type="submit">Sök</button>
            <button type="button" class="close-btn" id="closeSearchModal">Avbryt</button>
        </form>
        <!-- Loading symbol -->
        <div class="loading-container" id="loading-spinner-search" style="display: none;">
            <div class="loading-spinner-wrapper">
                <div class="loading-spinner"></div>
                <div class="loading-text">Laddar...</div>
            </div>
        </div>
        <ul id="treeList" class="file-list">
        </ul>
    </div>
</div>


<!-- Navigering -->
<div class="tree">
    {% include 'tree_content.html' %}
</div>

<a href="{{ url_for('repos') }}">Tillbaka till listan över projekt</a>


<div class="text-center">
    <a href="{{ url_for('logout') }}" class="btn btn-primary btn-lg">
        <i class="bi bi-github"></i> Logga ut.
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Öppna modalen för att skapa mapp
    document.getElementById('openCreateModal').onclick = function () {
        document.getElementById('createFolderModal').style.display = 'block';
    }

    // Stäng modalen för att skapa mapp
    document.getElementById('closeCreateModal').onclick = function () {
        document.getElementById('createFolderModal').style.display = 'none';
    }

    // Öppna modalen för att ladda upp fil
    document.getElementById('openUploadModal').onclick = function () {
        document.getElementById('uploadFileModal').style.display = 'block';
    }

    // Stäng modalen för att ladda upp fil
    document.getElementById('closeUploadModal').onclick = function () {
        document.getElementById('uploadFileModal').style.display = 'none';
    }

    // Öppna modalen för att söka
    document.getElementById('openSearchModal').onclick = function () {
        document.getElementById('searchModal').style.display = 'block';
    }

    // Stäng modalen för att söka
    document.getElementById('closeSearchModal').onclick = function () {
        document.getElementById('searchModal').style.display = 'none';
    }

    // Stäng modal om användaren klickar utanför
    window.onclick = function (event) {
        if (event.target == document.getElementById('createFolderModal')) {
            document.getElementById('createFolderModal').style.display = 'none';
        }
        if (event.target == document.getElementById('uploadFileModal')) {
            document.getElementById('uploadFileModal').style.display = 'none';
        }
        if (event.target == document.getElementById('searchModal')) {
            document.getElementById('searchModal').style.display = 'none';
        }
    }
</script>
<script>
    // Hantera sökningen
    document.getElementById("searchForm").addEventListener("submit", function (event) {
        event.preventDefault();
        var searchTerm = document.getElementById("searchTerm").value.toLowerCase();
        var sha = "{{ request.args.get('sha', 'HEAD') }}";
        var treeList = document.getElementById("treeList");
        treeList.innerHTML = ''; // Töm listan
        const loadingSpinner = document.getElementById('loading-spinner-search');
        // Visa laddar-symbolen
        loadingSpinner.style.display = 'flex';

        fetch(`{{ url_for('search_repo', repo_name=repo_name, owner=owner) }}?q=${searchTerm}&sha=${sha}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    // Om inga resultat hittades
                    var li = document.createElement("li");
                    li.textContent = "Inget resultat";
                    treeList.appendChild(li);
                } else {
                    data.forEach(function (item) {
                        var li = document.createElement("li");
                        if (item.type === 'tree') {
                            li.innerHTML = `<span class="file-type folder-icon"></span> <a href="${item.href}" class="searchresult">${item.path}</a>`;
                        } else if (item.type === 'blob') {
                            li.innerHTML = `<span class="file-type file-icon"></span> <a href="${item.href}" class="searchresult">${item.path}</a>`;
                        }
                        treeList.appendChild(li);
                    });
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                // Dölj laddar-symbolen
                loadingSpinner.style.display = 'none';
            });
    });

    // Ladda mappar dynamiskt med event delegation och laddar-symbol
    document.addEventListener('DOMContentLoaded', function () {
        var searchtreeList = document.getElementById("treeList");

        searchtreeList.addEventListener('click', function (event) {
            if (event.target.tagName === 'A' && event.target.closest('.searchresult')) {
                event.preventDefault();
                let url = event.target.getAttribute('href');
                load_tree_content(url)
                document.getElementById('searchModal').style.display = 'none';
            }
        });
    });
</script>

<script>
    // Öppna redigeringsmodalen
    document.querySelector('.tree').addEventListener('click', function (event) {
        if (event.target.classList.contains('edit-file-link')) {
            event.preventDefault();
            const filePath = event.target.dataset.filepath;
            fetch(`{{ url_for('get_file_content', repo_name=repo_name, owner=owner) }}?path=${filePath}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('filepathlabel').innerHTML = filePath
                    document.getElementById('editFilePath').value = filePath;
                    document.getElementById('editFileContent').value = data.content;
                    document.getElementById('editFileModal').style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
        }
    });


    document.addEventListener('click', function (event) {
        // Kontrollera om klicket är på knappen för att stänga redigeringsmodulen
        if (event.target && event.target.id === 'closeEditModal') {
            document.getElementById('editFileModal').style.display = 'none';
        }

        // Kontrollera om användaren klickade utanför modalen för att stänga den
        const editFileModal = document.getElementById('editFileModal');
        if (event.target === editFileModal) {
            editFileModal.style.display = 'none';
        }
    });
</script>

<script>
    // Ladda mappar dynamiskt med event delegation och laddar-symbol
    document.addEventListener('DOMContentLoaded', function () {
        const treeContainer = document.querySelector('.tree');

        treeContainer.addEventListener('click', function (event) {
            if (event.target.tagName === 'A' && event.target.closest('.folder')) {
                event.preventDefault();
                let url = event.target.getAttribute('href');
                load_tree_content(url)
            }
        });
    });

    function load_tree_content(url) {
        const treeContainer = document.querySelector('.tree');

        // Visa laddar-symbolen
        const loadingSpinner = document.getElementById('loading-spinner');
        loadingSpinner.style.display = 'flex'; // Flex för att använda flexbox

        fetch(url, {
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
            .then(response => response.text())
            .then(html => {
                // Uppdatera innehållet
                treeContainer.innerHTML = html;
                treeContainer.appendChild(loadingSpinner); // Lägg tillbaka laddar-symbolen i DOM:en
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                // Dölj laddar-symbolen
                loadingSpinner.style.display = 'none';
            });
    };
</script>
{% endblock %}