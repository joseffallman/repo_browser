{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.2.1/ol.css">
<style>
    /* GitHub-liknande filstruktur */
    .file-list {
        list-style: none;
        padding-left: 0;
        text-align: left;
    }

    .file-list li {
        border-bottom: 1px solid #e1e4e8;
        padding: 8px 10px;
        display: block;
        align-items: center;
    }

    .file-list li a {
        text-decoration: none;
        color: #0366d6;
        font-weight: 600;
        /* flex-grow: 1;*/
    }

    .file-list li a:hover {
        text-decoration: underline;
    }

    .file-list li .file-type {
        margin-right: 8px;
        width: 16px;
        height: 16px;
        display: inline-block;
    }

    .file-list li .folder-icon {
        background: url('https://github.githubassets.com/images/icons/emoji/unicode/1f4c1.png') no-repeat center center;
        background-size: contain;
    }

    .file-list li .file-icon {
        background: url('https://github.githubassets.com/images/icons/emoji/unicode/1f4c4.png') no-repeat center center;
        background-size: contain;
    }

    /* Plus och upload knapp */
    .plus-button,
    .upload-button,
    .search-button {
        position: fixed;
        width: 50px;
        height: 50px;
        background-color: #007BFF;
        color: white;
        border-radius: 50%;
        font-size: 30px;
        text-align: center;
        line-height: 50px;
        cursor: pointer;
        padding: 0px 0px;
    }

    .plus-button {
        bottom: 30px;
        right: 20px;
    }

    .upload-button {
        bottom: 90px;
        right: 20px;
    }

    .search-button {
        bottom: 150px;
        right: 20px;
    }

    /* Redigeringsmodal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1060;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        padding-top: 60px;
    }

    @media (max-width: 800px) {
        .modal {
            padding-top: 0px;
        }
    }

    .modal-content {
        background-color: #fefefe;
        margin: 0px auto;
        padding: 5px;
        border: 1px solid #888;
        width: 100%;
        max-width: 800px;
        text-align: center;
    }

    @media (max-width: 800px) {
        .modal-content {
            height: 100%;
        }
    }

    .search-modal-content {
        min-height: 60vh;
    }

    .modal-content textarea {
        width: 100%;
        height: 400px;
        font-family: monospace;
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
    }

    .modal-content input[type="text"],
    .modal-content input[type="number"],
    .modal-content input[type="file"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 20px;
    }

    #searchTerm {
        width: 70%;
        padding: 10px;
        margin-bottom: 0px;
    }


    .modal-content button {
        padding: 5px 10px;

        /* background-color: #007BFF; */
        color: white;
        border: none;
        cursor: pointer;
    }

    .modal-content button.close-btn {
        background-color: red;
    }

    /* Flikstyling */
    .tab {
        overflow: hidden;
        border-bottom: 1px solid #ccc;
    }

    .tab button {
        background-color: #007BFF;
        float: left;
        border: 1px #ccc solid;
        outline: none;
        cursor: pointer;
        padding: 4px 16px 4px;
        margin-top: 10px;
        transition: 0.3s;
        border-radius: 5px 5px 0px 0px;
    }

    .tab button:hover {
        background-color: #0366d6;
    }

    .tab button.active {
        background-color: #0366d6;
        padding: 14px 16px 4px;
        margin-top: 0px
    }

    .tabcontent {
        display: none;
        padding: 6px 12px;
        border-top: none;
    }

    #map {
        height: 400px;
        width: 100%;
        margin-bottom: 20px;
    }
</style>
<style>
    /* Stil för redigera point kods lista */
    #pointsListBox {
        margin: 1em 0px;
        touch-action: pan-y;
        /* Tillåt vertikal scroll men förhindra pinch-zoom */
        overflow-y: scroll;
        height: 50vh;
    }

    #pointsListBox .table-header {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background-color: #f0f0f0;
        font-weight: bold;
        border-bottom: 2px solid #ccc;
        font-family: Arial, sans-serif;
    }

    #pointsListBox #pointsList {
        list-style: none;
        padding: 0;
        margin: 0;
        font-family: Arial, sans-serif;
        border: 1px solid #ccc;
        display: flex;
        flex-direction: column;
    }

    /* Standardstil för punkterna */
    #pointsListBox #pointsList li {
        display: flex;
        justify-content: space-between;
        margin: 0px;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        background-color: #f9f9f9;
        cursor: pointer;
        user-select: none;
        /* Förhindrar att text markeras */
    }

    #pointsListBox #pointsList li:hover {
        background-color: #f0f0f0;
    }

    #pointsListBox #pointsList li.selected {
        background-color: #d1e7fd;
        /* Markeringsfärg */
    }

    #pointsListBox .table-header span,
    #pointsListBox #pointsList li span {
        width: 50%;
        /* Låter varje del av raden ta upp halva bredden */
    }

    #pointsListBox .editing {
        background-color: #fff;
        /* Ljus bakgrund för redigerbart läge */
        margin: 0px;
        padding: 5px;
    }

    #pointlistBtn {
        display: flex;
        flex-wrap: wrap;
        /* allow buttons to wrap to a new line if there's not enough space */
        justify-content: center;
        /* align buttons horizontally in the middle */
        gap: 10px;
        /* add some space between the buttons */
    }


    /* Styling for the lock icon */
    .lock-container {
        display: flex;
        align-items: baseline;
        justify-content: space-around;
    }

    .lock-icon {
        font-size: 24px;
        margin-right: 10px;
        cursor: pointer;
    }

    .locked .lock-icon {
        color: gray;
        /* Color for locked state */
    }

    .unlocked .lock-icon {
        color: green;
        /* Color for unlocked state */
    }

    /* Filter-modal stil */
    .filter-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 80%;
        max-width: 400px;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
        z-index: 1070;
    }

    .filter-content {
        display: flex;
        flex-direction: column;
    }

    .filter-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
    }

    #saveAsModal .input-group {
        display: flex;
        align-items: center;
    }

    #saveAsModal .input-group input {
        flex-grow: 1;
        width: auto;
        margin-bottom: 0;
        padding: 10px;
    }

    .input-group .input-group-text {
        padding: 10px;
    }
</style>

<style>
    /* Styles for the Kartan  */
    /* Styla popup-elementet som en pratbubbla */
    .ol-popup {
        background-color: white;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        position: relative;
        bottom: 12px;
        border: 1px solid #cccccc;
        min-width: 150px;
    }

    /* Skapa en liten triangel som blir "svansen" på pratbubblan */
    .ol-popup:after {
        content: '';
        position: absolute;
        bottom: -30px;
        left: 50%;
        margin-left: -15px;
        border-width: 15px;
        border-style: solid;
        border-color: white transparent transparent transparent;
    }

    /* Om du vill ändra färgen på pratbubblan kan du ändra här */
    .ol-popup:before {
        content: '';
        position: absolute;
        bottom: -38px;
        left: 50%;
        margin-left: -19px;
        border-width: 19px;
        border-style: solid;
        border-color: #cccccc transparent transparent transparent;
    }

    .ol-zoom button {
        padding: 0px;
        color: grey;
    }

    .ol-attribution li {
        background: none;
    }

    #map-info-filter {
        padding: 0 20px;
    }
</style>
{% endblock %}

{% block title %}Innehåll i projekt: {{ repo_name }}{% endblock %}
{% block body %}



<!-- Plus-knapp -->
<button class="plus-button" id="openCreateModal">
    <span class="iconify" data-icon="mdi-folder-plus-outline"></span>
</button>

<!-- Upload-knapp -->
<button class="upload-button" id="openUploadModal">
    <span class="iconify" data-icon="mdi-file-upload-outline"></span>
</button>

<!-- Sök-knapp -->
<button class="search-button" id="openSearchModal">
    <span class="iconify" data-icon="mdi-search"></span>
</button>

<!-- Modal för sökning -->
<div id="searchModal" class="modal fade" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">Sök efter filer eller mappar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="searchForm">
                    <div class="mb-3">
                        <label for="searchTerm" class="form-label">Ange sökord:</label>
                        <div class="input-group">
                            <input type="text" id="searchTerm" name="searchTerm" class="form-control" required>
                            <button type="button" class="btn btn-outline-secondary" id="clearSearchTerm"
                                title="Töm sökord">
                                <i class="bi bi-x"></i> <!-- Om du använder Bootstrap Icons -->
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Sök</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                </form>
                <ul id="treeList" class="file-list">
                    <!-- Lista med filer -->
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal för att ladda upp fil -->
<!-- Bootstrap Modal -->
<div id="uploadFileModal" class="modal fade" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFileModalLabel">Ladda upp fil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Filen kommer att laddas in i:</p>
                <div id="folderPath" class="p-1 mt-2 mb-5 bg-warning rounded-3">/</div>
                <form id="uploadFileForm" action="{{ url_for('upload_file', repo_name=repo_name) }}" method="post"
                    enctype="multipart/form-data">
                    <input type="hidden" name="path" value="{{ path }}">
                    <input type="hidden" name="owner" value="{{ owner }}">
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Välj fil</label>
                        <input type="file" name="file" id="fileInput" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary" onclick="loadingSpinner(true)">Ladda upp</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal för att skapa ny mapp -->
<div id="createFolderModal" class="modal fade" tabindex="-1" aria-labelledby="createFolderModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createFolderModalLabel">Skapa ny mapp</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Den nya mappen kommer att skapas i:</p>
                <div id="folderPath" class="p-1 mt-2 mb-5 bg-warning rounded-3">/</div>
                <form id="createFolderForm" action="{{ url_for('create_folder', repo_name=repo_name) }}" method="post">
                    <input type="hidden" name="path" value="{{ path }}">
                    <input type="hidden" name="owner" value="{{ owner }}">
                    <div class="mb-3">
                        <label for="folderName" class="form-label">Nytt mappnamn:</label>
                        <input type="text" name="folder_name" id="folderName" class="form-control"
                            placeholder="Ny mappnamn" required>
                    </div>
                    <button type="submit" class="btn btn-primary" onclick="loadingSpinner(true)">Skapa mapp</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Modal för att redigera filer -->
<div id="editFileModal" class="modal">
    <div class="modal-content">

        <!-- Flikar -->
        <div class="tab">
            <button class="tablinks" id="defaultOpen" onclick="openTab(event, 'FileView')">Visa</button>
            <button class="tablinks" id="editTab" onclick="openTab(event, 'FileContent')">Redigera</button>
            <button class="tablinks" id="mapTab" style="display:none;" onclick="openTab(event, 'Map')">Karta</button>
            <button class="tablinks" id="editCode" style="display:none;"
                onclick="openTab(event, 'editPointCode')">Redigera punktkod</button>
        </div>

        <!-- Flikinnehåll -->
        <div id="FileView" class="tabcontent">
            <p class="h3">Granska fil</p>
            <p class="filepathlabel small"></p>
            <textarea id="viewFileContent" class="file-content" disabled></textarea>
            <button id="closeEditModal" type="button" class="btn btn-danger">Avbryt</button>
        </div>

        <div id="FileContent" class="tabcontent">
            <p class="h3">Redigera fil</p>
            <p class="filepathlabel small"></p>
            <form id="editFileForm" action="{{ url_for('edit_file', repo_name=repo_name) }}" method="post">
                <input type="hidden" name="path" id="editFilePath">
                <input type="hidden" name="newpath" id="newFilePath">
                <input type="hidden" name="owner" id="owner" value="{{ owner }}">
                <select id="actionSelect" name="action" hidden>
                    <option value="update">Update</option>
                    <option value="create">Create</option>
                    <option value="append">Append</option>
                </select>
                <input type="hidden" name="projCRS" id="projCRS">
                <textarea name="content" id="editFileContent"></textarea>
                <br>
                <button type="button" class="saveBtn btn btn-primary" data-action="rawEdit">Spara ändringar</button>
                <button id="closeEditModal" type="button" class="btn btn-danger">Avbryt</button>
            </form>
        </div>

        <div id="editPointCode" class="tabcontent">
            <p class="h3">Redigera punktkod</p>
            <div class="lock-container">
                <label for="newDes">Ny kod:</label>
                <input type="text" id="newDes" placeholder="Ange ny kod">
                <span id="lockIcon" class="lock-icon">
                    <span class="iconify" data-icon="mdi-lock-open"></span>
                </span>
            </div>
            <div id="pointlistBtn">
                <button id="updateAllBtn" class="btn btn-primary">Uppdatera alla</button>
                <button id="updateSelectedBtn" class="btn btn-primary" disabled>Uppdatera markerade</button>
                <button id="clearSelectionBtn" class="btn btn-primary" disabled>Rensa markering</button>
                <button id="selectAllBtn" class="btn btn-primary">Markera alla</button>
                <button id="filterBtn" class="btn btn-primary">Filter</button>
            </div>

            <!-- Filter-dialogruta som visas vid klick på Filter-knappen -->
            <div id="filterModal" class="filter-modal" style="display: none;">
                <div class="filter-content">
                    <h4>Välj filter</h4>
                    <div>
                        <input type="checkbox" id="idFilterCheck" checked>
                        <label for="idFilterCheck">Filter på ID</label>
                        <input type="number" id="minId" placeholder="Min ID">
                        <input type="number" id="maxId" placeholder="Max ID">
                    </div>
                    <div>
                        <input type="checkbox" id="desFilterCheck" checked>
                        <label for="desFilterCheck">Filter på Punktkod</label>
                        <input type="text" id="filterByDes" placeholder="Filtrera på Punktkod">
                    </div>
                    <div class="filter-actions">
                        <button id="applyFilterBtn">Tillämpa filter</button>
                        <button id="closeFilterBtn">Stäng</button>
                    </div>
                </div>
            </div>

            <div id="pointsListBox">
                <div class="table-header">
                    <span>ID</span>
                    <span>Punktkod</span>
                </div>
                <ul id="pointsList"></ul>
                <br>
            </div>
            <button type="button" class="saveBtn btn btn-primary" data-action="editPointCode">Spara ändringar</button>
            <button id="saveAsButton" type="button" class="btn btn-primary" disabled>Spara som</button>
            <button id="closeEditModal" type="button" class="btn btn-danger">Avbryt</button>
        </div>

        <div id="Map" class="tabcontent">
            <h3>Karta</h3>
            <div id="map"></div>
            <span id="map-info-filter" class="text-secondary fw-lighter"></span>
            <button type="button" class="btn btn-primary" onclick="fitMarkers()">Återställ zoomnivå</button>
            <button id="closeEditModal" type="button" class="btn btn-danger">Avbryt</button>
        </div>

    </div>
</div>

<!-- Varningsmodal -->
<div class="modal fade" id="warningModal" tabindex="-1" role="dialog" aria-labelledby="warningModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class=" modal-title" id="warningModalLabel">Varning!</h5>

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Innan du sparar så måste du försäkra att Inmätningsutrustningen är avstängd.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmSaveBtn">Jag har stängt av
                    utrustningen</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Avbryt</button>
            </div>
        </div>
    </div>
</div>

<!-- SparaSomModal -->
<div class="modal fade" id="saveAsModal" tabindex="-1" role="dialog" aria-labelledby="saveAsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class=" modal-title" id="saveAsModalLabel">Spara till ny!</h5>

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Ange ett namn på den nya filen som du vill spara de filtrerade punkterna till.</p>
                <p class="p-2 mb-3 bg-warning text-dark rounded"><span id="countSelected"
                        class="font-weight-bold"></span> st
                    punkter har valts!</p>
                <div class="input-group">
                    <input type="text" id="saveAsInput" class="form-control" placeholder="Namn på filen">
                    <span class="input-group-text">.crd</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="saveBtn btn btn-primary" data-action="saveAsPointCode"
                    data-bs-dismiss="modal">Spara som</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Avbryt</button>
            </div>
        </div>
    </div>
</div>


<!-- Navigering -->
<div class="tree">
    {% include 'tree_content.html' %}
</div>

<a href="{{ url_for('repos') }}">Tillbaka till listan över projekt</a>


<div class="text-center">
    <a href="{{ url_for('logout') }}" class="btn btn-primary btn-lg">
        <i class="bi bi-door-open-fill"></i> Logga ut.
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    function getPath(includeSlash = false) {
        // Get the current page path
        let myElement = document.getElementById('path');
        var path = "";
        if (myElement) {
            path = myElement.getAttribute('data-path');
        }

        if (includeSlash == true && path != "/") {
            return "/" + path + "/"
        } else {
            return path;
        }
    }
</script>
<script>
    // Öppna modalen för att skapa mapp
    document.getElementById('openCreateModal').onclick = function () {

        var createFolderElement = document.getElementById('createFolderModal');
        var createDirModal = new bootstrap.Modal(createFolderElement);
        var form = document.getElementById('createFolderForm');
        var hiddenInput = form.querySelector('input[name="path"]');
        hiddenInput.value = getPath();
        createFolderElement.querySelector('#folderPath').textContent = getPath(true);
        console.log(hiddenInput.value);
        createDirModal.show();
    }

    // Öppna modalen för att ladda upp fil
    document.getElementById('openUploadModal').onclick = function () {

        // document.getElementById('uploadFileModal').style.display = 'block';
        var uploadFileElement = document.getElementById('uploadFileModal');
        var uploadFileModal = new bootstrap.Modal(uploadFileElement);
        var form = document.getElementById('uploadFileForm');
        var hiddenInput = form.querySelector('input[name="path"]');
        hiddenInput.value = getPath();
        uploadFileElement.querySelector('#folderPath').textContent = getPath(true);
        console.log(hiddenInput.value);
        uploadFileModal.show();
    }

    // Öppna modalen för att söka
    document.getElementById('openSearchModal').onclick = function () {
        var searchModal = new bootstrap.Modal(document.getElementById('searchModal'));
        searchModal.show();

    }
</script>
<script>
    // Hantera sökningen
    document.getElementById("searchForm").addEventListener("submit", function (event) {
        event.preventDefault();
        var searchTerm = document.getElementById("searchTerm").value.toLowerCase();
        var sha = "{{ request.args.get('sha', 'HEAD') }}";
        var treeList = document.getElementById("treeList");
        treeList.innerHTML = ''; // Töm listan

        // Visa laddar-symbolen
        loadingSpinner(true);

        fetch(`{{ url_for('search_repo', repo_name=repo_name, owner=owner) }}?q=${searchTerm}&sha=${sha}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    // Om inga resultat hittades
                    var li = document.createElement("li");
                    li.textContent = "Inget resultat";
                    treeList.appendChild(li);
                } else {
                    data.forEach(function (item) {
                        var li = document.createElement("li");
                        if (item.type === 'tree') {
                            li.innerHTML = `<span class="file-type folder-icon"></span> <a href="${item.href}" class="searchresult">${item.path}</a>`;
                        } else if (item.type === 'blob') {
                            li.innerHTML = `<span class="file-type file-icon"></span> <a href="${item.href}" class="searchresult">${item.path}</a>`;
                        }
                        treeList.appendChild(li);
                    });
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                // Dölj laddar-symbolen
                loadingSpinner(false);
            });
    });

    // Ladda mappar dynamiskt med event delegation och laddar-symbol
    document.addEventListener('DOMContentLoaded', function () {
        var searchtreeList = document.getElementById("treeList");

        searchtreeList.addEventListener('click', function (event) {
            if (event.target.tagName === 'A' && event.target.closest('.searchresult')) {
                event.preventDefault();
                let url = event.target.getAttribute('href');
                load_tree_content(url)
                var searchModal = bootstrap.Modal.getInstance(document.getElementById('searchModal'));
                searchModal.hide();
            }
        });
    });

    // Hämta kryssknappen och inputfältet
    document.getElementById('clearSearchTerm').addEventListener('click', function () {
        document.getElementById('searchTerm').value = ''; // Tömmer inputfältet
        var treeList = document.getElementById("treeList");
        treeList.innerHTML = ''; // Töm listan
    });
</script>

<script>
    // Funktion för att öppna en flik
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;

        // Dölj allt flikinnehåll
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Ta bort 'active' klassen från alla flikar
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Visa nu vald flik och lägg till 'active' klassen på den valda knappen
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";

        if (tabName == "Map") {
            fitMarkers();
        };
    }
</script>

<!-- OpenLayers library -->
<script src="https://cdn.jsdelivr.net/npm/ol@v10.2.1/dist/ol.js"></script>
<!-- Proj4JS Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.12.1/proj4.js"></script>

<script>
    // --==( KARTAN och dess funktioner )==--

    // Definiera SWEREF 99 TM (EPSG:3006)
    proj4.defs("EPSG:3006", "+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs");

    // Definiera SWEREF 99 13 30 (EPSG:3007)
    proj4.defs("EPSG:3007", "+proj=utm +zone=13 +ellps=GRS80 +units=m +no_defs");

    // Definiera SWEREF 99 15 00 (EPSG:3008)
    proj4.defs("EPSG:3008", "+proj=utm +zone=15 +ellps=GRS80 +units=m +no_defs");

    // Registrera proj4 i OpenLayers
    ol.proj.proj4.register(proj4);

    // Skapa kartan
    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([17.6389, 59.8586]), // WGS84 center (long, lat)
            zoom: 18,
            maxZoom: 30,
        })
    });

    var markersLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
    });
    map.addLayer(markersLayer);
    var projCRS = "EPSG:3006";

    // Skala-linje kontroll
    const scaleLineControl = new ol.control.ScaleLine({
        units: 'metric', // Använd meter/kilometer
        minWidth: 100,   // Minsta bredd för skala-linjen
    });

    // Lägg till skala-linjen till kartan
    map.addControl(scaleLineControl);


    function removeMarker() {
        markersLayer.getSource().clear(); // Rensar alla markörer
    }

    function fitMarkers() {
        const extent = markersLayer.getSource().getExtent();
        // Kontrollera om extenten är giltig (inte innehåller Infinity)
        if (!extent.some(value => !isFinite(value))) {
            map.updateSize();

            //Padding (in pixels) to be cleared inside the view. Values in the array are top, right, bottom and left padding.
            const padding = [20, 20, 20, 20];

            map.getView().fit(extent, { size: map.getSize(), padding });
        } else {
        }
    }

    function setProjection(projection = projCRS) {
        if (projCRS != projection) {
            projCRS = projection;
        }
        return;
    }

    function displayMap(fileContent) {

        var featuresToAdd = [];
        var totalPoints = 0;
        var showCount = 0;

        // Loopar igenom punkterna och lägger till dem på kartan
        fileContent.points.forEach(point => {
            totalPoints++;
            if (!filterPoint(point)) {
                return;
            }
            showCount++;
            var sourceCoords = [parseFloat(point.eas.toFixed(4)), parseFloat(point.nor.toFixed(4))];
            sourceCoords = ol.proj.transform(sourceCoords, projCRS, 'EPSG:3857');

            // Skapa en markör (feature) och lägg till den i vektorkällan
            const marker = new ol.Feature({
                geometry: new ol.geom.Point(sourceCoords),
                type: 'marker',
                id: point.id,
                description: point.des,
                northing: point.nor,
                easting: point.eas
            });
            featuresToAdd.push(marker);

        });

        // Lägg till alla punkter till vektorkällan
        markersLayer.getSource().addFeatures(featuresToAdd);

        if (showCount < totalPoints) {
            // Visa ett meddelande om antalet punkter som visas
            var message = "Filter aktivt. Visar " + showCount + "/" + totalPoints + " punkter.";
            document.getElementById('map-info-filter').innerHTML = message;
        } else {
            document.getElementById('map-info-filter').innerHTML = "Visar " + totalPoints + " punkter.";
        }

        fitMarkers();
    }

    // Skapa popup-elementet
    const popupElement = document.createElement('div');
    popupElement.className = 'ol-popup'; // Lägg till popup-styling

    // Lägg till knappar för föregående och nästa
    const prevButton = document.createElement('button');
    prevButton.innerHTML = '◀ Föregående';
    prevButton.style.marginRight = '10px';
    prevButton.style.padding = '2px';
    prevButton.onclick = function () {
        if (currentFeatureIndex > 0) {
            currentFeatureIndex--;
            updatePopupContent();
        }

        if (currentFeatureIndex == 0) {
            prevButton.disabled = true;
        } else {
            nextButton.disabled = false;
        }
    };

    const nextButton = document.createElement('button');
    nextButton.innerHTML = 'Nästa ▶';
    nextButton.style.marginLeft = '10px';
    nextButton.style.padding = '2px';
    nextButton.onclick = function () {
        if (currentFeatureIndex < foundFeatures.length - 1) {
            currentFeatureIndex++;
            updatePopupContent();
        }

        if (currentFeatureIndex == foundFeatures.length) {
            nextButton.disabled = true;
        } else {
            prevButton.disabled = false;
        }
    };

    // Skapa en container för knapparna
    const buttonContainer = document.createElement('div');
    buttonContainer.style.display = 'flex';
    buttonContainer.style.justifyContent = 'center';
    buttonContainer.style.marginTop = '10px';
    buttonContainer.style.position = 'relative';
    buttonContainer.style.top = '5px';
    buttonContainer.appendChild(prevButton);
    buttonContainer.appendChild(nextButton);

    popupElement.appendChild(buttonContainer);

    const popup = new ol.Overlay({
        element: popupElement,
        positioning: 'bottom-center',
        stopEvent: false,
        offset: [0, -15],
    });
    map.addOverlay(popup);

    // Hantera logiken för att bläddra mellan features
    let currentFeatureIndex = 0;
    let foundFeatures = [];

    // Funktion för att uppdatera popup-innehållet baserat på den aktuella feature-index
    function updatePopupContent() {
        const feature = foundFeatures[currentFeatureIndex];
        const coords = feature.getGeometry().getCoordinates();
        popup.getElement().innerHTML = `ID:<b>${feature.get('id')}</b><br>Kod:<b>${feature.get('description')}</b>`;

        if (foundFeatures.length > 1) {
            // Lägg till navigationsknapparna igen efter att HTML har uppdaterats
            popup.getElement().appendChild(buttonContainer);
        }

        // Flytta popup-positionen till den aktuella feature
        popup.setPosition(coords);

        // Hantera om knapparna ska vara inaktiva
        prevButton.disabled = (currentFeatureIndex === 0);
        nextButton.disabled = (currentFeatureIndex === foundFeatures.length - 1);
    }

    // Hantera popup vid klick på markör
    map.on('click', function (evt) {
        // Kontrollera om klicket var på popupen eller dess element
        if (evt.originalEvent.target.closest('.ol-popup')) {
            // Klickade på popup-elementet, stäng inte popupen
            return;
        }

        // Definiera en buffert i pixlar
        const bufferInPixels = 10;
        const clickedCoordinate = evt.coordinate;
        const mapResolution = map.getView().getResolution();

        // Beräkna en buffert i koordinater baserat på resolution och bufferInPixels
        const bufferInCoords = bufferInPixels * mapResolution;

        const extentWithBuffer = ol.extent.boundingExtent([
            [clickedCoordinate[0] - bufferInCoords, clickedCoordinate[1] - bufferInCoords],
            [clickedCoordinate[0] + bufferInCoords, clickedCoordinate[1] + bufferInCoords]
        ]);

        foundFeatures = markersLayer.getSource().getFeaturesInExtent(extentWithBuffer);

        if (foundFeatures.length > 0) {
            currentFeatureIndex = 0;
            prevButton.disabled = true;
            updatePopupContent();
        } else {
            // Dölj popup om ingen markör hittas
            popup.setPosition(undefined);
        }
    });
</script>
<script>
    // Funktioner för att hantera listan över punktkoderna.
    let currentPointData = null;
    const pointsList = document.getElementById('pointsList');
    const filterModal = document.getElementById('filterModal');
    let isSelecting = false; // För att hålla koll på om musen är nere
    let startY = 0;
    let multiTouch = false; // För att spåra om två fingrar används
    let selectedItems = new Set(); // Set för att hålla koll på markerade rader

    // Öppna filter-dialogen
    document.getElementById('filterBtn').addEventListener('click', () => {
        filterModal.style.display = 'block';
    });

    // Stäng filter-dialogen
    document.getElementById('closeFilterBtn').addEventListener('click', () => {
        filterModal.style.display = 'none';
    });

    function setCurrentPointData(fileContent) {
        currentPointData = fileContent; // Spara data i den globala variabeln
        document.getElementById('newDes').value = ''; // Sätt textfältet till tomma
    }

    function filterActive() {
        const minIdInput = document.getElementById('minId');
        const maxIdInput = document.getElementById('maxId');
        const filterByDesInput = document.getElementById('filterByDes');

        const applyIdFilter = document.getElementById('idFilterCheck').checked;
        const applyDesFilter = document.getElementById('desFilterCheck').checked;

        return (
            (applyDesFilter && filterByDesInput !== '') &&
            (applyIdFilter && (minIdInput !== '' || maxIdInput !== ''))
        );
    }

    function filterPoint(point) {
        const minIdInput = document.getElementById('minId');
        const maxIdInput = document.getElementById('maxId');
        const filterByDesInput = document.getElementById('filterByDes');
        // Hämta min- och maxvärde från inputfälten (range)
        const minId = parseInt(minIdInput.value, 10);
        const maxId = parseInt(maxIdInput.value, 10);
        const filterByDes = filterByDesInput.value.toLowerCase();

        // Kontrollera om filter är aktiverade
        const applyIdFilter = document.getElementById('idFilterCheck').checked;
        const applyDesFilter = document.getElementById('desFilterCheck').checked;

        const pointId = parseInt(point.id, 10);

        // Kontrollera om ID är inom angivet intervall om ID-filter är aktiverat
        const isWithinIdRange = (!applyIdFilter || (
            (!isNaN(minId) ? pointId >= minId : true) &&
            (!isNaN(maxId) ? pointId <= maxId : true)
        )
        );

        // Kontrollera om beskrivningen matchar om Punktkod-filter är aktiverat
        const matchesDescription = (!applyDesFilter || filterByDes === '' || point.des.toLowerCase().includes(filterByDes));

        // Om både ID-range och Punktkod matchar, visa punkten
        if (isWithinIdRange && matchesDescription) {
            return true;
        }
        return false;
    }

    function renderPointsList() {
        pointsList.innerHTML = ''; // Töm listan först

        currentPointData.points.forEach(point => {
            const pointId = parseInt(point.id, 10);

            // Om punkten är synlig, visa den
            if (filterPoint(point)) {
                const listItem = document.createElement('li');
                listItem.setAttribute('data-id', point.id);
                listItem.innerHTML = `<span>${point.id}</span><span class="description">${point.des}</span>`;
                if (selectedItems.has(point.id)) {
                    listItem.classList.add('selected');
                }
                pointsList.appendChild(listItem);
            }
        });
    }
    // Event listeners för filtreringsfälten
    document.getElementById('minId').addEventListener('input', renderPointsList);
    document.getElementById('maxId').addEventListener('input', renderPointsList);
    document.getElementById('filterByDes').addEventListener('input', renderPointsList);
    // Event listener för att tillämpa filter
    document.getElementById('applyFilterBtn').addEventListener('click', () => {
        renderPointsList(); // Tillämpa filtren på listan

        // Uppdatera markeringarna på kartan
        removeMarker();
        displayMap(currentPointData);

        filterModal.style.display = 'none'; // Stäng filterdialogen
    });

    // Uppdatera alla punkter
    document.getElementById('updateAllBtn').addEventListener('click', () => {
        const newDes = document.getElementById('newDes').value;
        if (newDes.trim()) {
            currentPointData.points.forEach(point => {
                if (filterPoint(point)) {
                    point.des = newDes; // Uppdatera alla punkter
                }
            });
            renderPointsList();
        } else {
            alert('Ange en giltig beskrivning.');
        }
    });

    // Uppdatera markerade punkter
    document.getElementById('updateSelectedBtn').addEventListener('click', () => {
        const newDes = document.getElementById('newDes').value;
        if (newDes.trim()) {
            selectedItems.forEach(id => {
                const point = currentPointData.points.find(p => p.id === id);
                if (point) {
                    point.des = newDes; // Uppdatera de markerade punkterna
                }
            });
            renderPointsList(); // Återskapa listan
            clearSelection(); // Rensa markering efter uppdatering
        } else {
            alert('Ange en giltig beskrivning.');
        }
    });


    // Rensa alla markerade rader
    document.getElementById('clearSelectionBtn').addEventListener('click', () => {
        clearSelection();
    });

    // Markera alla rader
    document.getElementById('selectAllBtn').addEventListener('click', () => {
        selectAll();
    });

    // Hantera "klick och dra"-markering
    pointsList.addEventListener('mousedown', (event) => {
        const listItem = event.target.closest('li'); // Fånga närmaste <li>
        if (listItem) {
            isSelecting = true;
            lastListItem = listItem;
            toggleSelection(listItem);
            updateInputCodeText(listItem); // Uppdatera beskrivningsfältet efter att vi togglat markeringen.
        }
    });

    lastListItem = null;
    pointsList.addEventListener('mouseover', (event) => {
        const listItem = event.target.closest('li');
        if (isSelecting && listItem && lastListItem !== listItem) {
            lastListItem = listItem;
            toggleSelection(listItem); // Fortsätt markera om musen dras
        }
    });
    document.addEventListener('mouseup', () => {
        isSelecting = false; // Släpp urvalet när musknappen släpps
    });

    // När första fingret sätts ned
    pointsList.addEventListener('touchstart', (event) => {
        if (event.touches.length === 1) {
            // Om ett finger hålls ned, aktivera inte markering men sätt upp för att "hålla fast"
            multiTouch = false;
            startY = event.touches[0].clientY;
            isSelecting = false; // Markering är inte aktiv än
        } else if (event.touches.length === 2) {
            // När två fingrar används, starta markeringsläget
            multiTouch = true;
            isSelecting = true;  // Aktivera markeringsläget
            const touch = event.touches[1];  // Andra fingret som ska markera
            startY = touch.clientY;
            const liElement = document.elementFromPoint(touch.clientX, touch.clientY).closest('li');
            if (liElement) {
                lastListItem = liElement;
                toggleSelection(liElement);
            }
        }
    });

    // Förhindra pinch-to-zoom
    pointsList.addEventListener('touchmove', function (event) {
        if (event.touches.length > 1) {
            event.preventDefault(); // Förhindra zoomning
        }
    }, { passive: false });

    // När ett andra finger drar för att markera
    pointsList.addEventListener('touchmove', (event) => {
        if (isSelecting && event.touches.length === 2) {
            const touch = event.touches[1];  // Använd andra fingret för att spåra markering
            const currentY = touch.clientY;

            // Kontrollera om användaren drar vertikalt
            if (Math.abs(currentY - startY) > 10) { // Threshold för att känna igen en dragning
                const liElement = document.elementFromPoint(touch.clientX, currentY).closest('li');
                if (liElement && liElement !== lastListItem) {
                    toggleSelection(liElement);
                    lastListItem = liElement;
                }
            }
        }
    });

    pointsList.addEventListener('touchend', (event) => {
        if (event.touches.length === 0) {
            // Återställ efter släpp
            isSelecting = false;
            multiTouch = false;
            lastListItem = null;
        }
    });

    // Växla markering på rad
    function toggleSelection(item) {
        const id = item.getAttribute('data-id');
        if (selectedItems.has(id)) {
            selectedItems.delete(id); // Ta bort markering
            item.classList.remove('selected');
        } else {
            selectedItems.add(id); // Lägg till markering
            item.classList.add('selected');
        }
        updateSaveButtonState();
    }

    // Rensa alla markeringar
    function clearSelection() {
        selectedItems.clear(); // Rensa setet
        document.querySelectorAll('#pointsList li').forEach(item => {
            item.classList.remove('selected'); // Ta bort markeringsstilen
        });
        updateSaveButtonState();
    }

    // Markera alla rader
    function selectAll() {
        selectedItems.clear(); // Rensa setet
        document.querySelectorAll('#pointsList li').forEach(item => {
            const id = item.getAttribute('data-id');
            selectedItems.add(id);
            if (!item.classList.contains('selected')) {
                item.classList.add('selected');
            } // Lägg till markeringsstilen
        });

        updateSaveButtonState();
    }

    function updateSaveButtonState() {
        // Uppdatera knapper beroende på antal valda punkter.
        const saveButton = document.getElementById("saveAsButton");
        const clearSelectionBtn = document.getElementById("clearSelectionBtn");
        const updateSelectionBtn = document.getElementById("updateSelectedBtn");
        saveButton.disabled = selectedItems.size === 0; // Avaktivera om Set är tom
        clearSelectionBtn.disabled = selectedItems.size === 0; // Avaktivera om Set är tom
        updateSelectionBtn.disabled = selectedItems.size === 0; // Avaktivera om Set är tom
    }

    // Växla mellan låst och olåst läge
    function isLocked() {
        return document.getElementById('lockIcon').classList.contains('locked');
    }

    document.getElementById('lockIcon').addEventListener('click', () => {
        const lockIcon = document.getElementById('lockIcon');
        if (isLocked()) {
            lockIcon.innerHTML = '<span class="iconify" data-icon="mdi-lock-open"></span>'; // Byt till olåst ikon
            lockIcon.classList.remove('locked');
        } else {
            lockIcon.innerHTML = '<span class="iconify" data-icon="mdi-lock"></span>'; // Byt till låst ikon
            lockIcon.classList.add('locked');
        }
    });

    function updateInputCodeText(item) {
        if (isLocked()) {
            return;
        }
        const id = item.getAttribute('data-id');
        if (selectedItems.has(id)) {
            const point = currentPointData.points.find(p => p.id === id);
            if (point) {
                document.getElementById('newDes').value = point.des;
            }
        }
    }

    // Användaren har bekräftat, så nu kan vi skicka formuläret
    document.getElementById("saveAsButton").addEventListener("click", function () {

        // Sätt den nya filnamet
        const saveAsInput = document.getElementById('saveAsInput');
        const filePath = document.getElementById('editFilePath').value;
        const newFilePath = filePath.replace(/\.crd$/, "");
        saveAsInput.value = newFilePath

        // Uppdatera antalet valda punkter
        document.getElementById('countSelected').innerText = selectedItems.size;

        // Visa spara som modalen
        var saveAsModal = document.getElementById('saveAsModal');
        var modal = new bootstrap.Modal(saveAsModal);

        // Lägg till en eventlistener som flyttar markören till slutet när modalen visas
        saveAsModal.addEventListener('shown.bs.modal', function () {
            const saveAsInput = document.getElementById('saveAsInput');
            saveAsInput.focus();
            saveAsInput.setSelectionRange(saveAsInput.value.length, saveAsInput.value.length);
        });

        modal.show();
    });

    let editFilePageWhenSaving = '';  // Variabel för att hålla koll på vilken knapp som trycktes
    // Spara ändringar i filen.
    document.querySelectorAll(".saveBtn").forEach(function (button) {
        button.addEventListener("click", function () {

            editFilePageWhenSaving = button.getAttribute('data-action');
            // Visa varningsmodalen
            var warningModal = document.getElementById('warningModal');
            var modal = new bootstrap.Modal(warningModal);
            modal.show();
        });
    });

    // Användaren har bekräftat, så nu kan vi skicka formuläret
    document.getElementById("confirmSaveBtn").addEventListener("click", function () {
        editFileSave();
    });

    // document.getElementById('saveBtn').addEventListener('click', () => {
    function editFileSave() {
        // Bygg upp den data som ska skickas till servern
        const form = document.getElementById('editFileForm');
        const actionSelect = document.getElementById('actionSelect');
        const projCRSInput = document.getElementById('projCRS');
        // Uppdatera crs i formuläret.
        projCRSInput.value = projCRS;

        // Kontrollera vilken sida som lagrades när spara knappen trycktes
        if (editFilePageWhenSaving === 'editPointCode') {
            actionSelect.value = 'update';
            document.getElementById('editFileContent').value = JSON.stringify(currentPointData);
        } else if (editFilePageWhenSaving === 'saveAsPointCode') {
            actionSelect.value = 'create';

            // Spara valda punkter till ny fil.
            document.getElementById('newFilePath').value = document.getElementById('saveAsInput').value + ".crd";
            // Skapa en kopia av currentPointData
            const updatedPointData = {
                ...currentPointData,
                points: currentPointData.points.filter(point => selectedItems.has(point.id))
            };

            // Uppdatera editFileContent med den filtrerade kopian
            document.getElementById('editFileContent').value = JSON.stringify(updatedPointData);

            console.log(updatedPointData);
            console.log(document.getElementById('newFilePath').value);
            console.log(projCRSInput.value);
            console.log(actionSelect.value);
        }

        loadingSpinner(true);

        // Skicka formuläret till servern som returnerar en ny sida.
        form.submit();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const pointsList = document.getElementById('pointsList');
        let touchTimer = null;

        pointsList.addEventListener('dblclick', (event) => {
            const target = event.target;
            if (target.classList.contains('description')) {
                makeEditable(target);
            }
        });

        // Långtryck för mobila enheter
        pointsList.addEventListener('touchstart', (event) => {
            const target = event.target;

            if (target.classList.contains('description')) {
                touchTimer = setTimeout(() => {
                    makeEditable(target);
                }, 500); // Långtryck efter 500ms
            }
        });

        pointsList.addEventListener('touchmove', () => {
            clearTimeout(touchTimer); // Avbryt om det inte var en långtryck
        });

        pointsList.addEventListener('touchend', () => {
            clearTimeout(touchTimer); // Avbryt om det inte var en långtryck
        });

        // Gör ett element redigerbart
        function makeEditable(element) {
            const originalText = element.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalText;
            input.classList.add('editing');
            element.innerHTML = ''; // Töm elementets innehåll
            element.appendChild(input);
            input.focus();

            // Spara ändringar vid Enter eller när man klickar utanför
            input.addEventListener('blur', () => saveChanges(element, input));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveChanges(element, input);
                }
            });
        }

        // Spara ändringar och uppdatera den ursprungliga texten
        function saveChanges(element, input) {
            const newText = input.value.trim();
            if (newText !== '') {
                element.textContent = newText;
                // Här kan du också uppdatera currentPointData om det behövs
                updatePointDescription(element.parentElement.getAttribute('data-id'), newText);
            } else {
                element.textContent = input.value; // Återställ till originaltext om tom
            }
            element.classList.remove('editing');
        }

        // Uppdatera beskrivningen i currentData
        function updatePointDescription(id, newDescription) {
            const point = currentPointData.points.find(p => p.id === id);
            if (point) {
                point.des = newDescription;
            }
        }
    });
</script>

<script>
    // Öppna redigeringsmodalen
    function openEditModal(filePath, editProject = false) {
        document.getElementById("mapTab").style.display = "none";
        document.getElementById("editCode").style.display = "none";
        document.getElementById("editTab").style.display = "inline-block";
        document.getElementById('editFilePath').value = "";
        document.getElementById('editFileContent').value = "";
        document.getElementById('viewFileContent').value = "";
        document.getElementById('editFileModal').style.display = 'block';
        document.getElementById('pointsList').innerHTML = "";
        removeMarker();


        const filepathLabels = document.querySelectorAll('.filepathlabel');
        filepathLabels.forEach(element => {
            element.innerHTML = "";
        });

        // Öppna den första fliken som standard
        document.getElementById("defaultOpen").click();
        loadingSpinner(true);

        if (editProject) {
            document.getElementById("editTab").style.display = "none";
        }

        fetch(`{{ url_for('get_file_content', repo_name=repo_name, owner=owner) }}?path=${filePath}&editProject=${editProject}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('editFilePath').value = filePath;
                document.getElementById('editFileContent').value = data.content;
                document.getElementById('viewFileContent').value = data.content;
                filepathLabels.forEach(element => {
                    element.innerHTML = filePath;
                });


                // Kolla om filen är en .crd fil
                if (editProject) {
                    document.getElementById("mapTab").style.display = "inline-block";
                    document.getElementById("editCode").style.display = "inline-block";
                    //openTab(null, 'Map');  // Öppna kartfliken
                    document.getElementById("mapTab").click();
                    setProjection(data.info.CRS);
                    displayMap(JSON.parse(data.content));  // Visa kartan
                    setCurrentPointData(JSON.parse(data.content)); // Visa punktdatan
                    renderPointsList(); // Visa punktkodslista
                    document.getElementById("editCode").click();
                } else {
                    document.getElementById("mapTab").style.display = "none";
                    document.getElementById("editCode").style.display = "none";
                    //openTab(null, 'FileContent');  // Öppna filfliken
                    // Öppna den första fliken som standard
                    document.getElementById("defaultOpen").click();
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                loadingSpinner(false);
            });

    };


    function exportProject(filePath) {
        const originalString = filePath;
        const newFilePath = originalString.replace(/\.crd$/, ".rw5");

        // Show loading spinner.
        loadingSpinner(true);

        fetch(`{{ url_for('get_file_content', repo_name=repo_name, owner=owner) }}?path=${newFilePath}`)
            .then(response => response.json())
            .then(data => {
                const newFileContent = data.content.concat(" ");// Bygg upp den data som ska skickas till servern
                const form = document.getElementById('editFileForm');
                document.getElementById('editFileContent').value = newFileContent;
                document.getElementById('editFilePath').value = newFilePath;
                form.submit();
            })
            .finally(() => {
                loadingSpinner(false);
            });
    }

    document.querySelector('.tree').addEventListener('click', function (event) {
        if (event.target.classList.contains('edit-file-link')) {
            event.preventDefault();
            const filePath = event.target.dataset.filepath;
            openEditModal(filePath);
        }
    });

    document.addEventListener('submit', function (event) {
        // Kontrollera att det är formuläret med id 'editProject'
        if (event.target && event.target.id === 'editProject') {

            event.preventDefault();
            const selectedOption = document.getElementById("editProject").elements["project"].value;
            const project = JSON.parse(selectedOption);
            openEditModal(project.path, editProject = true);
        }
    });

    // Export project button
    document.addEventListener('click', function (event) {
        if (event.target && event.target.id === 'exportProject') {
            const selectedOption = document.getElementById("editProject").elements["project"].value;
            const project = JSON.parse(selectedOption);
            exportProject(project.path);
        }
    });


    document.addEventListener('click', function (event) {
        // Kontrollera om klicket är på knappen för att stänga redigeringsmodulen
        if (event.target && event.target.id === 'closeEditModal') {
            document.getElementById('editFileModal').style.display = 'none';
        }

        // Kontrollera om användaren klickade utanför modalen för att stänga den
        const editFileModal = document.getElementById('editFileModal');
        if (event.target === editFileModal) {
            editFileModal.style.display = 'none';
        }
    });
</script>

<script>
    // Ladda mappar dynamiskt med event delegation och laddar-symbol
    document.addEventListener('DOMContentLoaded', function () {
        const treeContainer = document.querySelector('.tree');

        treeContainer.addEventListener('click', function (event) {
            if (event.target.tagName === 'A' && event.target.closest('.folder')) {
                event.preventDefault();
                let url = event.target.getAttribute('href');
                load_tree_content(url)
            }
        });
    });

    function load_tree_content(url) {
        const treeContainer = document.querySelector('.tree');

        // Visa laddar-symbolen
        loadingSpinner(true);

        fetch(url, {
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
            .then(response => response.text())
            .then(html => {
                // Uppdatera innehållet
                treeContainer.innerHTML = html;
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                // Dölj laddar-symbolen
                loadingSpinner(false);
            });
    };
</script>
{% endblock %}